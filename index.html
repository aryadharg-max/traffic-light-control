<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Traffic Light Control Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    body { font-family: Arial, sans-serif; background: #121212; color: white; text-align: center; }
    h1 { margin-top: 10px; }
    .switch { margin: 10px; }
    .slider { width: 200px; }
    .circle {
        width: 100px; height: 100px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center; justify-content: center;
        font-size: 20px;
        margin: 10px;
        border: 4px solid white;
    }
    .red { border-color: red; }
    .yellow { border-color: yellow; color: yellow; }
    .green { border-color: lime; color: lime; }
</style>
</head>
<body>

<h1>ðŸš¦ Traffic Light Control Panel</h1>

<h2>Lights (Manual Mode Only)</h2>
<div>
    <label>Red</label>
    <input type="checkbox" id="redSwitch" class="switch">
    <label>Yellow</label>
    <input type="checkbox" id="yellowSwitch" class="switch">
    <label>Green</label>
    <input type="checkbox" id="greenSwitch" class="switch">
</div>

<h2>Light Timers (seconds)</h2>
<div>
    Red: <input type="range" min="1" max="60" id="redSlider" class="slider">
    <span id="redVal"></span> sec<br>
    Yellow: <input type="range" min="1" max="60" id="yellowSlider" class="slider">
    <span id="yellowVal"></span> sec<br>
    Green: <input type="range" min="1" max="60" id="greenSlider" class="slider">
    <span id="greenVal"></span> sec
</div>

<h2>Modes</h2>
<div>
    Automation: <input type="checkbox" id="automationSwitch" class="switch"><br>
    Sleep Mode: <input type="checkbox" id="sleepSwitch" class="switch">
</div>

<h2>Countdowns</h2>
<div>
    <div class="circle red" id="redCountdown">0</div>
    <div class="circle yellow" id="yellowCountdown">0</div>
    <div class="circle green" id="greenCountdown">0</div>
</div>

<script>
const AUTH_TOKEN = "NZ19PT_cHiLij0HUaiHefkShjfDKhhl5";
const DEVICE_URL = `https://blynk.cloud/external/api`;

// Helper to write to Blynk
function setPin(pin, value) {
    fetch(`${DEVICE_URL}/update?token=${AUTH_TOKEN}&${pin}=${value}`);
}

// Helper to read from Blynk
async function getPin(pin) {
    const res = await fetch(`${DEVICE_URL}/get?token=${AUTH_TOKEN}&${pin}`);
    return await res.json();
}

// Sync all controls from device
async function syncUI() {
    // Lights (invert logic)
    document.getElementById("redSwitch").checked = !(await getPin("V0") == "1");
    document.getElementById("yellowSwitch").checked = !(await getPin("V1") == "1");
    document.getElementById("greenSwitch").checked = !(await getPin("V2") == "1");

    // Timers
    document.getElementById("redSlider").value = await getPin("V3");
    document.getElementById("redVal").innerText = document.getElementById("redSlider").value;
    document.getElementById("yellowSlider").value = await getPin("V4");
    document.getElementById("yellowVal").innerText = document.getElementById("yellowSlider").value;
    document.getElementById("greenSlider").value = await getPin("V5");
    document.getElementById("greenVal").innerText = document.getElementById("greenSlider").value;

    // Modes
    document.getElementById("automationSwitch").checked = await getPin("V6") == "1";
    document.getElementById("sleepSwitch").checked = await getPin("V10") == "1";

    // Countdowns
    document.getElementById("redCountdown").innerText = await getPin("V7");
    document.getElementById("yellowCountdown").innerText = await getPin("V8");
    document.getElementById("greenCountdown").innerText = await getPin("V9");
}

// Event listeners
document.getElementById("redSwitch").addEventListener("change", e => setPin("V0", e.target.checked ? 0 : 1));
document.getElementById("yellowSwitch").addEventListener("change", e => setPin("V1", e.target.checked ? 0 : 1));
document.getElementById("greenSwitch").addEventListener("change", e => setPin("V2", e.target.checked ? 0 : 1));

document.getElementById("redSlider").addEventListener("input", e => {
    document.getElementById("redVal").innerText = e.target.value;
    setPin("V3", e.target.value);
});
document.getElementById("yellowSlider").addEventListener("input", e => {
    document.getElementById("yellowVal").innerText = e.target.value;
    setPin("V4", e.target.value);
});
document.getElementById("greenSlider").addEventListener("input", e => {
    document.getElementById("greenVal").innerText = e.target.value;
    setPin("V5", e.target.value);
});

document.getElementById("automationSwitch").addEventListener("change", e => setPin("V6", e.target.checked ? 1 : 0));
document.getElementById("sleepSwitch").addEventListener("change", e => setPin("V10", e.target.checked ? 1 : 0));

// Refresh countdowns every second
setInterval(async () => {
    document.getElementById("redCountdown").innerText = await getPin("V7");
    document.getElementById("yellowCountdown").innerText = await getPin("V8");
    document.getElementById("greenCountdown").innerText = await getPin("V9");
}, 1000);

// Sync UI on load
syncUI();
</script>
</body>
</html>
