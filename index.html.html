#define BLYNK_TEMPLATE_ID "TMPL31B0-Kdf5"
#define BLYNK_TEMPLATE_NAME "traffic light controller"
#define BLYNK_AUTH_TOKEN "NZ19PT_cHiLij0HUaiHefkShjfDKhhl5"

#include <WiFi.h>
#include <WiFiClient.h>
#include <BlynkSimpleEsp32.h>

// WiFi credentials
char ssid[] = "Test wifi";
char pass[] = "qwertyuiop";

// Pin setup
#define RED_PIN  2
#define YELLOW_PIN 4
#define GREEN_PIN 5

bool automationEnabled = false;

// Inverted logic: LOW = ON, HIGH = OFF
void setLight(int pin, bool on) {
  digitalWrite(pin, on ? LOW : HIGH);
}

// Blynk virtual pins
BLYNK_WRITE(V1) { setLight(RED_PIN, param.asInt() == 0); }    // Red
BLYNK_WRITE(V2) { setLight(YELLOW_PIN, param.asInt() == 0); } // Yellow
BLYNK_WRITE(V3) { setLight(GREEN_PIN, param.asInt() == 0); }  // Green
BLYNK_WRITE(V4) { automationEnabled = (param.asInt() == 0); } // Automation toggle

void setup() {
  Serial.begin(115200);
  pinMode(RED_PIN, OUTPUT);
  pinMode(YELLOW_PIN, OUTPUT);
  pinMode(GREEN_PIN, OUTPUT);

  // Lights off initially
  setLight(RED_PIN, false);
  setLight(YELLOW_PIN, false);
  setLight(GREEN_PIN, false);

  Blynk.begin(BLYNK_AUTH_TOKEN, ssid, pass);
}

void loop() {
  Blynk.run();

  if (automationEnabled) {
    setLight(RED_PIN, true);
    delay(3000);
    setLight(RED_PIN, false);

    setLight(GREEN_PIN, true);
    delay(3000);
    setLight(GREEN_PIN, false);

    setLight(YELLOW_PIN, true);
    delay(1000);
    setLight(YELLOW_PIN, false);
  }
}

